name: Phase 4 - Step 1: Collect Logs
on: [push]

jobs:
  collect-logs:
    runs-on: ubuntu-latest
    steps:
      
      # ACTION 1 : DÃ©marrer l'application
      - name: Start MongoDB and Backend
        run: |
          echo "ACTION 1: DÃ‰MARRER LES CONTENEURS"
          echo "----------------------------------"
          
          # 1.1 DÃ©marrer MongoDB
          docker run -d --name mongodb -p 27017:27017 mongo:latest
          echo "âœ… MongoDB started"
          
          # 1.2 Construire ton app
          cd backend
          docker build -t todo-app . 
          
          # 1.3 DÃ©marrer ton app
          docker run -d \
            --name todo-app \
            --link mongodb:mongodb \
            -e MONGO_URI=mongodb://mongodb:27017/todo_db \
            -p 5000:5000 \
            todo-app
          
          echo "âœ… Todo App started"
          echo "Waiting 10 seconds..."
          sleep 10
      
      # ACTION 2 : Voir les logs
      - name: View Logs with docker logs
        run: |
          echo ""
          echo "ACTION 2: VOIR LES LOGS"
          echo "-----------------------"
          echo "Command: docker logs todo-app"
          echo ""
          
          # 2.1 Voir les logs
          docker logs todo-app
      
      # ACTION 3 : Sauvegarder les logs
      - name: Save Logs to File
        run: |
          echo ""
          echo "ACTION 3: SAUVEGARDER LES LOGS"
          echo "------------------------------"
          
          # 3.1 Sauvegarder dans un fichier
          docker logs todo-app > my-app-logs.txt
          
          # 3.2 Montrer le fichier
          echo "âœ… File created: my-app-logs.txt"
          echo "First 5 lines:"
          head -5 my-app-logs.txt
          
          # 3.3 Infos sur le fichier
          echo ""
          echo "ðŸ“Š File info:"
          ls -lh my-app-logs.txt
          echo "Lines: $(wc -l < my-app-logs.txt)"
      
      # ACTION 4 : TÃ©lÃ©charger les preuves
      - name: Upload Proof
        uses: actions/upload-artifact@v4
        with:
          name: step1-logs-proof
          path: my-app-logs.txt
      
      - name: Cleanup
        run: |
          docker stop todo-app mongodb
          docker rm todo-app mongodb